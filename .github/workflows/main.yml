# This is a basic workflow to help you get started with Actions

name: BudgetBuddy CI/CD
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Configure Heroku Properties
        run: |
          # Injecting your custom properties before the Docker build starts
          echo "security.basic.enabled=false" >> src/main/resources/application-heroku.properties
          echo "spring.main.allow-bean-definition-overriding=true" >> src/main/resources/application-heroku.properties
      - name: Login to Heroku Registry
        env:
          HEROKU_API_KEY = ${{secrets.HEROKU_API_KEY}}
        run: |
          echo ${{ secrets.HEROKU_API_KEY }} | docker login --username=_ --password-stdin registry.heroku.com
      - name: Build and Push Docker Image
        env:
            HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }} 
        run: | 
          # We use buildx to match your local script's --provenance=false flag
          docker buildx build --provenance=false \
            -f heroku_deploy/Dockerfile \
            -t registry.heroku.com/$HEROKU_APP_NAME/web .
          
          docker push registry.heroku.com/$HEROKU_APP_NAME/web
          
      - name: Release and Verify
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          # Release the container
          heroku container:release web --app $HEROKU_APP_NAME
          
          # Verification steps from your script
          heroku releases --app $HEROKU_APP_NAME
          heroku ps --app $HEROKU_APP_NAME
          
          # Verify Redis connection (assuming the addon is already provisioned)
          heroku redis:info --app $HEROKU_APP_NAME

            

        
